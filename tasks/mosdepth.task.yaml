name: mosdepth
description: Run mosdepth to calculate depth of coverage for BAM.
auto_generate_session_for_account: "{workspaceBot}"

agent_requirements:
  cpu_cores: 8
  memory_gb: 8

parameters:
  - name: sample_name
    label: Sample Name
    type: string
    help: "Sample/patient name"

  - name: aligned_bam
    label: Aligned BAM
    type: file

  - name: output_folder
    label: Output Folder
    type: directory
    supports_location_mode: 'no_append'

  - name: cache_udocker_images
    label: Cache Udocker Image
    type: boolean
    value: true

steps:
  - name: mosdepth
    type: cmd
    description: Run mosdepth to calculate depth of coverage for BAM.
    args:
      - |- # shell
        set -eu pipefail

        echo "*************************"
        echo "Starting Mosdepth Task"
        echo "Space on agent: $(df -h /scratch | tail -n 1 | awk '{print $4}')"
        echo "Input Parameters:"
        echo "  - sample_name: $sample_name"
        echo "  - aligned_bam: $aligned_bam"
        echo "  - output_folder: $output_folder"
        echo "  - cache_udocker_images: $cache_udocker_images"
        echo "*************************"

        # Check if output files already exist
        echo "Checking if output files already exist..."
        OUTPUT_FILES_EXIST=true
        
        # Check for specific mosdepth output files
        OUTPUT_BED="${output_folder}/${sample_name}.regions.bed.gz"
        OUTPUT_BED_INDEX="${output_folder}/${sample_name}.regions.bed.gz.csi"
        OUTPUT_SUMMARY="${output_folder}/${sample_name}.mosdepth.summary.txt"
        
        if [ ! -f "$OUTPUT_BED" ] || [ ! -f "$OUTPUT_BED_INDEX" ] || [ ! -f "$OUTPUT_SUMMARY" ]; then
          OUTPUT_FILES_EXIST=false
          echo "  - Mosdepth output files missing"
        fi
        
        if [ "$OUTPUT_FILES_EXIST" = true ]; then
          echo "All output files already exist. Skipping task as no-op."
          echo "  - Regions BED: $(basename "$OUTPUT_BED") ($(format_file_size "$OUTPUT_BED"))"
          echo "  - BED Index: $(basename "$OUTPUT_BED_INDEX") ($(format_file_size "$OUTPUT_BED_INDEX"))"
          echo "  - Summary: $(basename "$OUTPUT_SUMMARY") ($(format_file_size "$OUTPUT_SUMMARY"))"
          echo "*************************"
          echo "Mosdepth Task completed (skipped - outputs exist)"
          echo "*************************"
          exit 0
        else
          echo "Output files missing. Proceeding with analysis..."
        fi

        # Source common utility functions
        source "$TASK_DIR/utils/utils.sh"

        # Set up env variables for miniwdl
        export MINIWDL__SCHEDULER__CONTAINER_BACKEND=udocker
        export MINIWDL__FILE_IO__ALLOW_ANY_INPUT=true
        export MINIWDL__SCHEDULER__TASK_CONCURRENCY=8
        export UDOCKER_DIR=/scratch/.udocker

        # Pull udocker layers from cache if requested
        if [ -d "${WORKSPACE_DIR}/${RESOURCES_PATH}/udocker_cache/${TASK_NAME}" ] && [ "$cache_udocker_images" = true ]; then
          echo "Pulling udocker image from cache..."
          mkdir -p /scratch/.udocker
          cp -R "${WORKSPACE_DIR}/${RESOURCES_PATH}/udocker_cache/${TASK_NAME}"/* /scratch/.udocker/ || \
            { echo "Failed to copy udocker cache to /scratch/.udocker; will pull layers instead"; }
        fi
        
        # Find BAM index file
        BAM_INDEX="${aligned_bam}.bai"
        if [ ! -f "$BAM_INDEX" ]; then
          echo "Error: BAM index file not found at $BAM_INDEX"
          echo "Please ensure the BAM file is indexed"
          exit 1
        fi

        # Copy BAM files to /scratch
        echo "Copying input files..."
        cp "${aligned_bam}" /scratch/
        cp "$BAM_INDEX" /scratch/
        LOCAL_BAM="/scratch/$(basename "${aligned_bam}")"
        LOCAL_BAM_INDEX="/scratch/$(basename "${BAM_INDEX}")"

        # Run Mosdepth analysis
        echo "================================================"
        echo "ðŸš€ STARTING MOSDEPTH ANALYSIS"
        echo "================================================"
        echo "ðŸ“… Server Time: $(date)"
        echo "ðŸ“ Input Files:"
        echo "  - Aligned BAM: $(basename "$LOCAL_BAM") ($(format_file_size "$LOCAL_BAM"))"
        echo "  - BAM Index: $(basename "$LOCAL_BAM_INDEX") ($(format_file_size "$LOCAL_BAM_INDEX"))"
        echo "âš™ï¸  Configuration:"
        echo "  - Sample: $sample_name"
        echo "  - Threads: $AGENT_CPU_CORES"
        echo "================================================"
        
        # Record start time
        MOSDEPTH_START_TIME=$(date +%s)
        
        # Define minidwl input JSON
        jq -n \
          --arg pname "$sample_name" \
          --arg bam "$LOCAL_BAM" \
          --arg bam_index "$LOCAL_BAM_INDEX" \
          --argjson threads "$AGENT_CPU_CORES" \
          '{
            "mosdepth.pname": $pname,
            "mosdepth.bam": $bam,
            "mosdepth.bam_index": $bam_index,
            "mosdepth.threads": $threads
          }' > /scratch/inputs.json

        # Run miniwdl and capture output
        set +e
        MOSDEPTH_OUTPUT=$(miniwdl run \
          "${TASK_DIR}/HiFi-somatic-WDL-0.9.2/tasks/common.wdl" \
          --task mosdepth \
          --dir /scratch \
          --runtime-cpu-max=$AGENT_CPU_CORES \
          --runtime-memory-max=${AGENT_MEMORY_GB}G \
          -i /scratch/inputs.json 2>/dev/null)
        MINIWDL_EXIT_CODE=$?
        set -e

        if [ $MINIWDL_EXIT_CODE -ne 0 ]; then
          echo "Mosdepth failed with exit code $MINIWDL_EXIT_CODE"
          handle_miniwdl_failure $MINIWDL_EXIT_CODE
        fi

        # Extract output file paths from MOSDEPTH_OUTPUT
        MOSDEPTH_OUTPUT_BED=$(echo "$MOSDEPTH_OUTPUT" | jq -r '.outputs."mosdepth.output_bed"')
        MOSDEPTH_OUTPUT_BED_INDEX=$(echo "$MOSDEPTH_OUTPUT" | jq -r '.outputs."mosdepth.output_bed_index"')
        MOSDEPTH_OUTPUT_SUMMARY=$(echo "$MOSDEPTH_OUTPUT" | jq -r '.outputs."mosdepth.output_summary"')

        # Post-execution logging for Mosdepth
        MOSDEPTH_END_TIME=$(date +%s)
        MOSDEPTH_DURATION=$((MOSDEPTH_END_TIME - MOSDEPTH_START_TIME))
        MOSDEPTH_DURATION_HOUR=$((MOSDEPTH_DURATION / 3600))
        MOSDEPTH_DURATION_MIN=$(((MOSDEPTH_DURATION % 3600) / 60))
        MOSDEPTH_DURATION_SEC=$((MOSDEPTH_DURATION % 60))
        
        echo "================================================"
        echo "âœ… MOSDEPTH ANALYSIS COMPLETED SUCCESSFULLY"
        echo "================================================"
        echo "â±ï¸  Execution Time: ${MOSDEPTH_DURATION_HOUR}h ${MOSDEPTH_DURATION_MIN}m ${MOSDEPTH_DURATION_SEC}s"
        echo "ðŸ“ Output Files:"
        
        if [ -f "$MOSDEPTH_OUTPUT_BED" ]; then
          echo "  - Regions BED: $(basename "$MOSDEPTH_OUTPUT_BED") ($(format_file_size "$MOSDEPTH_OUTPUT_BED"))"
        fi
        if [ -f "$MOSDEPTH_OUTPUT_BED_INDEX" ]; then
          echo "  - BED Index: $(basename "$MOSDEPTH_OUTPUT_BED_INDEX") ($(format_file_size "$MOSDEPTH_OUTPUT_BED_INDEX"))"
        fi
        if [ -f "$MOSDEPTH_OUTPUT_SUMMARY" ]; then
          echo "  - Summary: $(basename "$MOSDEPTH_OUTPUT_SUMMARY") ($(format_file_size "$MOSDEPTH_OUTPUT_SUMMARY"))"
        fi
        echo "================================================"

        # Copy output files to output folder
        echo "Copying mosdepth outputs..."
        if [ -f "$MOSDEPTH_OUTPUT_BED" ]; then
          cp "$MOSDEPTH_OUTPUT_BED" "$output_folder/${sample_name}.regions.bed.gz" 2>/dev/null || echo "Warning: Regions BED file not found"
        fi
        if [ -f "$MOSDEPTH_OUTPUT_BED_INDEX" ]; then
          cp "$MOSDEPTH_OUTPUT_BED_INDEX" "$output_folder/${sample_name}.regions.bed.gz.csi" 2>/dev/null || echo "Warning: BED index file not found"
        fi
        if [ -f "$MOSDEPTH_OUTPUT_SUMMARY" ]; then
          cp "$MOSDEPTH_OUTPUT_SUMMARY" "$output_folder/${sample_name}.mosdepth.summary.txt" 2>/dev/null || echo "Warning: Summary file not found"
        fi

        # Copy udocker cache to output folder
        if [ "$cache_udocker_images" = true ] && [ ! -d "${WORKSPACE_DIR}/${RESOURCES_PATH}/udocker_cache/${TASK_NAME}" ]; then
          mkdir -p "${WORKSPACE_DIR}/${RESOURCES_PATH}/udocker_cache/${TASK_NAME}"
          cp -r /scratch/.udocker/layers /scratch/.udocker/repos "${WORKSPACE_DIR}/${RESOURCES_PATH}/udocker_cache/${TASK_NAME}" 2>/dev/null || true
        fi

        echo "*************************"
        echo "Mosdepth completed successfully"
        echo "Output files copied to: $output_folder"
        echo "*************************"
        