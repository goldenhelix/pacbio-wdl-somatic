name: Phasing with HiPhase
description: Phase VCFs and haplotag BAMs with HiPhase
auto_generate_session_for_account: "{workspaceBot}"

agent_requirements:
  cpu_cores: 8
  memory_gb: 16

parameters: 
  - name: tumor_sample_name
    label: Sample Name (tumor)
    type: string
    help: "The name of the tumor sample with BAMs and VCFs to be phased."

  - name: normal_sample_name
    label: Sample Name (normal)
    type: string
    optional: true
    help: "The name of the normal sample with VCFs to be phased (note that only a tumor BAM is phased). If not provided, the workflow will run in tumor-only mode."

  - name: tumor_aligned_bam
    label: Aligned BAM (tumor)
    type: file
    pattern_match:
      - "*.bam"
    help: "The aligned BAM file for the tumor sample. VCFs will be searched for in the same directory as the BAM file."

  - name: normal_aligned_bam
    label: Aligned BAM (normal)
    type: file
    pattern_match:
      - "*.bam"
    optional: true
    help: "The aligned BAM file for the normal sample. Only required when normal_sample_name is provided."

  - name: output_folder
    label: Output Folder
    type: directory
    supports_location_mode: 'no_append'

  - name: cache_udocker_images
    label: Cache Udocker Image
    type: boolean
    value: true

steps:
  - name: hiphase
    type: cmd
    description: Phase VCFs and haplotag BAMs with HiPhase
    args:
      - |- # shell
        set -eu pipefail

        echo "*************************"
        echo "Starting Phasing with HiPhase Task"
        echo "Space on agent: $(df -h /scratch | tail -n 1 | awk '{print $4}')"
        echo "Input Parameters:"
        echo "  - tumor_sample_name: $tumor_sample_name"
        echo "  - normal_sample_name: $normal_sample_name"
        echo "  - tumor_aligned_bam: $tumor_aligned_bam"
        echo "  - normal_aligned_bam: $normal_aligned_bam"
        echo "  - output_folder: $output_folder"
        echo "  - cache_udocker_images: $cache_udocker_images"
        echo "*************************"

        # Check if output files already exist
        echo "Checking if output files already exist..."
        OUTPUT_FILES_EXIST=true
        
        # Check for tumor HiPhase output files
        TUMOR_PHASED_VCF="${output_folder}/${tumor_sample_name}.clair3.small_variants.correct_ref.phased.vcf.gz"
        TUMOR_PHASED_VCF_INDEX="${output_folder}/${tumor_sample_name}.clair3.small_variants.correct_ref.phased.vcf.gz.tbi"
        TUMOR_PHASED_BAM="${output_folder}/${tumor_sample_name}.hiphase.bam"
        TUMOR_PHASED_BAM_INDEX="${output_folder}/${tumor_sample_name}.hiphase.bam.bai"
        TUMOR_STATS_FILE="${output_folder}/${tumor_sample_name}.hiphase.stats.tsv"
        TUMOR_BLOCKS_FILE="${output_folder}/${tumor_sample_name}.hiphase.blocks.tsv"
        TUMOR_HAPLOTAGS_FILE="${output_folder}/${tumor_sample_name}.hiphase.haplotags.tsv.gz"
        
        # Check for normal HiPhase output files if normal sample is provided
        if [ -n "$normal_sample_name" ]; then
          NORMAL_PHASED_VCF="${output_folder}/${normal_sample_name}.clair3.small_variants.correct_ref.phased.vcf.gz"
          NORMAL_PHASED_VCF_INDEX="${output_folder}/${normal_sample_name}.clair3.small_variants.correct_ref.phased.vcf.gz.tbi"
          NORMAL_STATS_FILE="${output_folder}/${normal_sample_name}.hiphase.stats.tsv"
          NORMAL_BLOCKS_FILE="${output_folder}/${normal_sample_name}.hiphase.blocks.tsv"
          NORMAL_HAPLOTAGS_FILE="${output_folder}/${normal_sample_name}.hiphase.haplotags.tsv.gz"
        fi
        
        if [ ! -f "$TUMOR_PHASED_VCF" ] || [ ! -f "$TUMOR_PHASED_VCF_INDEX" ] || [ ! -f "$TUMOR_PHASED_BAM" ] || [ ! -f "$TUMOR_PHASED_BAM_INDEX" ] || [ ! -f "$TUMOR_STATS_FILE" ] || [ ! -f "$TUMOR_BLOCKS_FILE" ] || [ ! -f "$TUMOR_HAPLOTAGS_FILE" ]; then
          OUTPUT_FILES_EXIST=false
          echo "  - Tumor HiPhase output files missing"
        fi
        
        if [ -n "$normal_sample_name" ]; then
          if [ ! -f "$NORMAL_PHASED_VCF" ] || [ ! -f "$NORMAL_PHASED_VCF_INDEX" ] || [ ! -f "$NORMAL_STATS_FILE" ] || [ ! -f "$NORMAL_BLOCKS_FILE" ] || [ ! -f "$NORMAL_HAPLOTAGS_FILE" ]; then
            OUTPUT_FILES_EXIST=false
            echo "  - Normal HiPhase output files missing"
          fi
        fi
        
        if [ "$OUTPUT_FILES_EXIST" = true ]; then
          echo "All output files already exist. Skipping task as no-op."
          echo "*************************"
          echo "Phasing with HiPhase Task completed (skipped - outputs exist)"
          echo "*************************"
          exit 0
        else
          echo "Output files missing. Proceeding with analysis..."
        fi

        # Source common utility functions
        source "$TASK_DIR/utils/utils.sh"

        # Set up resource path
        PB_RESOURCES_DIR="${WORKSPACE_DIR}/${RESOURCES_PATH}/hifisomatic_resources"
        
        # Set up reference files (hardcoded from ref_map)
        REF_FASTA="${PB_RESOURCES_DIR}/GCA_000001405.15_GRCh38_no_alt_analysis_set_maskedGRC_exclusions_v2.fasta"
        REF_INDEX="${PB_RESOURCES_DIR}/GCA_000001405.15_GRCh38_no_alt_analysis_set_maskedGRC_exclusions_v2.fasta.fai"
        
        # Verify reference files exist
        if [ ! -f "$REF_FASTA" ]; then
          echo "Error: Reference FASTA file not found at $REF_FASTA"
          echo "Please ensure the PacBio WDL resources have been downloaded using the Download PacBio Reference Data Resources task"
          exit 1
        fi
        
        if [ ! -f "$REF_INDEX" ]; then
          echo "Error: Reference FASTA index file not found at $REF_INDEX"
          echo "Please ensure the PacBio WDL resources have been downloaded using the Download PacBio Reference Data Resources task"
          exit 1
        fi

        # Check for required input files
        
        # Validate normal sample parameters
        if [ -n "$normal_sample_name" ] && [ -z "$normal_aligned_bam" ]; then
          echo "Warning: Normal sample name provided but no normal BAM file specified. Running in tumor-only mode."
          normal_sample_name=""
        elif [ -z "$normal_sample_name" ] && [ -n "$normal_aligned_bam" ]; then
          echo "Warning: Normal BAM file provided but no normal sample name specified. Running in tumor-only mode."
          normal_aligned_bam=""
        fi

        # Check for BAM and BAM index
        if [ ! -f "$tumor_aligned_bam" ]; then
          echo "Error: Aligned BAM file not found at $tumor_aligned_bam"
          exit 1
        fi

        tumor_aligned_bam_index="${tumor_aligned_bam}.bai"
        if [ ! -f "$tumor_aligned_bam_index" ]; then
          echo "Error: BAM index file not found at $tumor_aligned_bam_index"
          exit 1
        fi

        # Get input directory
        input_dir=$(dirname "$tumor_aligned_bam")

        # Check for clair3 VCF and index

        tumor_clair3_vcf="${input_dir}/${tumor_sample_name}.clair3.small_variants.correct_ref.vcf.gz"
        tumor_clair3_vcf_index="${tumor_clair3_vcf}.tbi"

        if [ ! -f "$tumor_clair3_vcf" ]; then
          echo "Error: Clair3 VCF file not found at $tumor_clair3_vcf"
          exit 1
        fi

        if [ ! -f "$tumor_clair3_vcf_index" ]; then
          echo "Error: Clair3 VCF index file not found at $tumor_clair3_vcf_index"
          exit 1
        fi

        # Check for DeepSomatic VCF and index 

        deepsomatic_vcf="${input_dir}/${tumor_sample_name}.deepsomatic.vcf.gz"
        deepsomatic_vcf_index="${deepsomatic_vcf}.tbi"
        if [ ! -f "$deepsomatic_vcf" ]; then
          echo "Error: DeepSomatic VCF file not found at $deepsomatic_vcf"
          exit 1
        fi
        if [ ! -f "$deepsomatic_vcf_index" ]; then
          echo "Error: DeepSomatic VCF index file not found at $deepsomatic_vcf_index"
          exit 1
        fi
      
        # Check for normal VCF and index if normal sample name is provided
        if [ -n "$normal_sample_name" ]; then
          normal_clair3_vcf="${input_dir}/${normal_sample_name}.clair3.small_variants.correct_ref.vcf.gz"
          normal_clair3_vcf_index="${normal_clair3_vcf}.tbi"
          if [ ! -f "$normal_clair3_vcf" ]; then
            echo "Error: Clair3 VCF file not found at $normal_clair3_vcf"
            exit 1
          fi
          if [ ! -f "$normal_clair3_vcf_index" ]; then
            echo "Error: Clair3 VCF index file not found at $normal_clair3_vcf_index"
            exit 1
          fi
          
          # Check for normal BAM and BAM index
          if [ ! -f "$normal_aligned_bam" ]; then
            echo "Error: Normal aligned BAM file not found at $normal_aligned_bam"
            exit 1
          fi
          
          normal_aligned_bam_index="${normal_aligned_bam}.bai"
          if [ ! -f "$normal_aligned_bam_index" ]; then
            echo "Error: Normal BAM index file not found at $normal_aligned_bam_index"
            exit 1
          fi
        fi

        # Copy all inputs to /scratch
        cp "$tumor_aligned_bam" "$tumor_aligned_bam_index" "$REF_FASTA" "$REF_INDEX" "$tumor_clair3_vcf" "$tumor_clair3_vcf_index" \
            "$deepsomatic_vcf" "$deepsomatic_vcf_index" /scratch/

        if [ -n "$normal_sample_name" ]; then
          cp "$normal_clair3_vcf" "$normal_clair3_vcf_index" "$normal_aligned_bam" "$normal_aligned_bam_index" /scratch/
        fi

        # Set local file paths
        LOCAL_BAM="/scratch/$(basename "${tumor_aligned_bam}")"
        LOCAL_BAM_INDEX="/scratch/$(basename "${tumor_aligned_bam_index}")"
        LOCAL_REF_FASTA="/scratch/$(basename "$REF_FASTA")"
        LOCAL_REF_INDEX="/scratch/$(basename "$REF_INDEX")"
        LOCAL_CLAIR3_VCF="/scratch/$(basename "${tumor_clair3_vcf}")"
        LOCAL_CLAIR3_VCF_INDEX="/scratch/$(basename "${tumor_clair3_vcf_index}")"
        LOCAL_DEEPSOMATIC_VCF="/scratch/$(basename "${deepsomatic_vcf}")"
        LOCAL_DEEPSOMATIC_VCF_INDEX="/scratch/$(basename "${deepsomatic_vcf_index}")"
        if [ -n "$normal_sample_name" ]; then
          LOCAL_NORMAL_CLAIR3_VCF="/scratch/$(basename "${normal_clair3_vcf}")"
          LOCAL_NORMAL_CLAIR3_VCF_INDEX="/scratch/$(basename "${normal_clair3_vcf_index}")"
          LOCAL_NORMAL_BAM="/scratch/$(basename "${normal_aligned_bam}")"
          LOCAL_NORMAL_BAM_INDEX="/scratch/$(basename "${normal_aligned_bam_index}")"
        fi

        # Generate phased VCF names (matching downstream.wdl line 83)
        PHASED_CLAIR3_VCF_NAME="$(basename "${tumor_clair3_vcf}" .vcf.gz).phased.vcf.gz"
        PHASED_DEEPSOMATIC_VCF_NAME="$(basename "${deepsomatic_vcf}" .vcf.gz).phased.vcf.gz"
        if [ -n "$normal_sample_name" ]; then
          PHASED_NORMAL_CLAIR3_VCF_NAME="$(basename "${normal_clair3_vcf}" .vcf.gz).phased.vcf.gz"
        fi

        # Generate phased VCF index names
        PHASED_CLAIR3_VCF_INDEX_NAME="$(basename "${tumor_clair3_vcf_index}" .vcf.gz.tbi).phased.vcf.gz.tbi"
        PHASED_DEEPSOMATIC_VCF_INDEX_NAME="$(basename "${deepsomatic_vcf_index}" .vcf.gz.tbi).phased.vcf.gz.tbi"
        if [ -n "$normal_sample_name" ]; then
          PHASED_NORMAL_CLAIR3_VCF_INDEX_NAME="$(basename "${normal_clair3_vcf_index}" .vcf.gz.tbi).phased.vcf.gz.tbi"
        fi

        cd /scratch
        # Check if HiPhase is already cached, otherwise download and extract
        if [ -d "${WORKSPACE_DIR}/${RESOURCES_PATH}/hiphase_cache/hiphase-v1.5.0-x86_64-unknown-linux-gnu" ] && [ "$cache_udocker_images" = true ]; then
          cp -r "${WORKSPACE_DIR}/${RESOURCES_PATH}/hiphase_cache/hiphase-v1.5.0-x86_64-unknown-linux-gnu" /scratch/
        else
          curl -L -O https://github.com/PacificBiosciences/HiPhase/releases/download/v1.5.0/hiphase-v1.5.0-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf hiphase-v1.5.0-x86_64-unknown-linux-gnu.tar.gz
        fi
        HIPHASE_BIN="/scratch/hiphase-v1.5.0-x86_64-unknown-linux-gnu/hiphase"
        chmod +x "$HIPHASE_BIN"

        # Verify hiphase binary
        "$HIPHASE_BIN" --version >/dev/null 2>&1

        # Run HiPhase analysis
        echo "================================================"
        echo "ðŸš€ STARTING HIPHASE ANALYSIS"
        echo "================================================"
        echo "ðŸ“… Server Time: $(date)"
        echo "ðŸ“ Input Files:"
        echo "  - Tumor BAM: $(basename "$LOCAL_BAM") ($(format_file_size "$LOCAL_BAM"))"
        echo "  - Clair3 VCF: $(basename "$LOCAL_CLAIR3_VCF") ($(format_file_size "$LOCAL_CLAIR3_VCF"))"
        echo "  - DeepSomatic VCF: $(basename "$LOCAL_DEEPSOMATIC_VCF") ($(format_file_size "$LOCAL_DEEPSOMATIC_VCF"))"
        if [ -n "$normal_sample_name" ]; then
          echo "  - Normal BAM: $(basename "$LOCAL_NORMAL_BAM") ($(format_file_size "$LOCAL_NORMAL_BAM"))"
          echo "  - Normal Clair3 VCF: $(basename "$LOCAL_NORMAL_CLAIR3_VCF") ($(format_file_size "$LOCAL_NORMAL_CLAIR3_VCF"))"
        fi
        echo "  - Reference FASTA: $(basename "$LOCAL_REF_FASTA") ($(format_file_size "$LOCAL_REF_FASTA"))"
        echo "âš™ï¸  Configuration:"
        echo "  - Tumor Sample: $tumor_sample_name"
        if [ -n "$normal_sample_name" ]; then
          echo "  - Normal Sample: $normal_sample_name"
        fi
        echo "  - Threads: $AGENT_CPU_CORES"
        echo "================================================"
        
        # Record start time
        HIPHASE_START_TIME=$(date +%s)
        
        set +e

        # Running tumor hiphase
        "$HIPHASE_BIN" \
          --threads $AGENT_CPU_CORES \
          --sample-name "$tumor_sample_name" \
          --vcf "$LOCAL_CLAIR3_VCF" \
          --vcf "$LOCAL_DEEPSOMATIC_VCF" \
          --output-vcf "$PHASED_CLAIR3_VCF_NAME" \
          --output-vcf "$PHASED_DEEPSOMATIC_VCF_NAME" \
          --bam "$LOCAL_BAM" \
          --output-bam "$tumor_sample_name.hiphase.bam" \
          --reference "$LOCAL_REF_FASTA" \
          --summary-file "$tumor_sample_name.hiphase.stats.tsv" \
          --blocks-file "$tumor_sample_name.hiphase.blocks.tsv" \
          --haplotag-file "$tumor_sample_name.hiphase.haplotags.tsv" 2>/dev/null

        # Running normal hiphase
        if [ -n "$normal_sample_name" ]; then
          "$HIPHASE_BIN" \
            --threads $AGENT_CPU_CORES \
            --sample-name "$normal_sample_name" \
            --vcf "$LOCAL_NORMAL_CLAIR3_VCF" \
            --output-vcf "$PHASED_NORMAL_CLAIR3_VCF_NAME" \
            --bam "$LOCAL_NORMAL_BAM" \
            --output-bam "$normal_sample_name.hiphase.bam" \
            --reference "$LOCAL_REF_FASTA" \
            --summary-file "$normal_sample_name.hiphase.stats.tsv" \
            --blocks-file "$normal_sample_name.hiphase.blocks.tsv" \
            --haplotag-file "$normal_sample_name.hiphase.haplotags.tsv" 2>/dev/null
        fi

        HIPHASE_EXIT_CODE=$?
        set -e

        if [ $HIPHASE_EXIT_CODE -ne 0 ]; then
          echo "HiPhase failed with exit code $HIPHASE_EXIT_CODE"
          exit $HIPHASE_EXIT_CODE
        fi

        # Post-execution logging for HiPhase
        HIPHASE_END_TIME=$(date +%s)
        HIPHASE_DURATION=$((HIPHASE_END_TIME - HIPHASE_START_TIME))
        HIPHASE_DURATION_HOUR=$((HIPHASE_DURATION / 3600))
        HIPHASE_DURATION_MIN=$(((HIPHASE_DURATION % 3600) / 60))
        HIPHASE_DURATION_SEC=$((HIPHASE_DURATION % 60))
        
        echo "================================================"
        echo "âœ… HIPHASE ANALYSIS COMPLETED SUCCESSFULLY"
        echo "================================================"
        echo "â±ï¸  Execution Time: ${HIPHASE_DURATION_HOUR}h ${HIPHASE_DURATION_MIN}m ${HIPHASE_DURATION_SEC}s"
        echo "ðŸ“ Output Files:"
        echo "  - Phased Clair3 VCF: $PHASED_CLAIR3_VCF_NAME"
        echo "  - Phased DeepSomatic VCF: $PHASED_DEEPSOMATIC_VCF_NAME"
        echo "  - Phased Tumor BAM: ${tumor_sample_name}.hiphase.bam"
        echo "  - Summary File: ${tumor_sample_name}.hiphase.stats.tsv"
        echo "  - Blocks File: ${tumor_sample_name}.hiphase.blocks.tsv"
        echo "  - Haplotag File: ${tumor_sample_name}.hiphase.haplotags.tsv"
        if [ -n "$normal_sample_name" ]; then
          echo "  - Phased Normal Clair3 VCF: $PHASED_NORMAL_CLAIR3_VCF_NAME"
          echo "  - Phased Normal BAM: ${normal_sample_name}.hiphase.bam"
          echo "  - Normal Summary File: ${normal_sample_name}.hiphase.stats.tsv"
          echo "  - Normal Blocks File: ${normal_sample_name}.hiphase.blocks.tsv"
          echo "  - Normal Haplotag File: ${normal_sample_name}.hiphase.haplotags.tsv"
        fi
        echo "================================================"

        # Copy all outputs to output folder
        echo "Copying HiPhase outputs..."
        HIPHASE_OUTPUT_FILES=()
        
        # Copy phased VCFs
        if [ -f "$PHASED_CLAIR3_VCF_NAME" ]; then
          HIPHASE_OUTPUT_FILES+=("$PHASED_CLAIR3_VCF_NAME")
        fi
        if [ -f "$PHASED_DEEPSOMATIC_VCF_NAME" ]; then
          HIPHASE_OUTPUT_FILES+=("$PHASED_DEEPSOMATIC_VCF_NAME")
        fi
        if [ -n "$normal_sample_name" ] && [ -f "$PHASED_NORMAL_CLAIR3_VCF_NAME" ]; then
          HIPHASE_OUTPUT_FILES+=("$PHASED_NORMAL_CLAIR3_VCF_NAME")
        fi
        
        # Copy phased VCF indices
        if [ -f "$PHASED_CLAIR3_VCF_INDEX_NAME" ]; then
          HIPHASE_OUTPUT_FILES+=("$PHASED_CLAIR3_VCF_INDEX_NAME")
        fi
        if [ -f "$PHASED_DEEPSOMATIC_VCF_INDEX_NAME" ]; then
          HIPHASE_OUTPUT_FILES+=("$PHASED_DEEPSOMATIC_VCF_INDEX_NAME")
        fi
        if [ -n "$normal_sample_name" ] && [ -f "$PHASED_NORMAL_CLAIR3_VCF_INDEX_NAME" ]; then
          HIPHASE_OUTPUT_FILES+=("$PHASED_NORMAL_CLAIR3_VCF_INDEX_NAME")
        fi
        
        # Copy haplotagged BAMs and indices
        if [ -f "$tumor_sample_name.hiphase.bam" ]; then
          HIPHASE_OUTPUT_FILES+=("$tumor_sample_name.hiphase.bam")
        fi
        if [ -f "$tumor_sample_name.hiphase.bam.bai" ]; then
          HIPHASE_OUTPUT_FILES+=("$tumor_sample_name.hiphase.bam.bai")
        fi
        if [ -n "$normal_sample_name" ]; then
          if [ -f "$normal_sample_name.hiphase.bam" ]; then
            HIPHASE_OUTPUT_FILES+=("$normal_sample_name.hiphase.bam")
          fi
          if [ -f "$normal_sample_name.hiphase.bam.bai" ]; then
            HIPHASE_OUTPUT_FILES+=("$normal_sample_name.hiphase.bam.bai")
          fi
        fi
        
        # Copy phase statistics files
        if [ -f "$tumor_sample_name.hiphase.stats.tsv" ]; then
          HIPHASE_OUTPUT_FILES+=("$tumor_sample_name.hiphase.stats.tsv")
        fi
        if [ -f "$tumor_sample_name.hiphase.blocks.tsv" ]; then
          HIPHASE_OUTPUT_FILES+=("$tumor_sample_name.hiphase.blocks.tsv")
        fi
        gzip "$tumor_sample_name.hiphase.haplotags.tsv"
        if [ -f "$tumor_sample_name.hiphase.haplotags.tsv.gz" ]; then
          HIPHASE_OUTPUT_FILES+=("$tumor_sample_name.hiphase.haplotags.tsv.gz")
        fi
        if [ -n "$normal_sample_name" ]; then
          if [ -f "$normal_sample_name.hiphase.stats.tsv" ]; then
            HIPHASE_OUTPUT_FILES+=("$normal_sample_name.hiphase.stats.tsv")
          fi
          if [ -f "$normal_sample_name.hiphase.blocks.tsv" ]; then
            HIPHASE_OUTPUT_FILES+=("$normal_sample_name.hiphase.blocks.tsv")
          fi
          gzip "$normal_sample_name.hiphase.haplotags.tsv"
          if [ -f "$normal_sample_name.hiphase.haplotags.tsv.gz" ]; then
            HIPHASE_OUTPUT_FILES+=("$normal_sample_name.hiphase.haplotags.tsv.gz")
          fi
        fi
        
        if [ ${#HIPHASE_OUTPUT_FILES[@]} -gt 0 ]; then
          copy_with_progress "$output_folder" "${HIPHASE_OUTPUT_FILES[@]}"
        fi
        
        # Copy HiPhase binary to cache for future use
        if [ "$cache_udocker_images" = true ]; then
          mkdir -p "${WORKSPACE_DIR}/${RESOURCES_PATH}/hiphase_cache"
          cp -r /scratch/hiphase-v1.5.0-x86_64-unknown-linux-gnu "${WORKSPACE_DIR}/${RESOURCES_PATH}/hiphase_cache/" 2>/dev/null || true
        fi
        

        # Remove input files from input folder (Redundant and expensive to keep)
        echo "Removing input files from input folder..."
        {
          rm -f "$input_dir/$(basename "$tumor_aligned_bam")"
          rm -f "$input_dir/$(basename "$tumor_aligned_bam_index")"
          rm -f "$input_dir/$(basename "$tumor_clair3_vcf")"
          rm -f "$input_dir/$(basename "$tumor_clair3_vcf_index")"
          rm -f "$input_dir/$(basename "$deepsomatic_vcf")"
        } || { 
          echo "Error: Failed to remove input files from input folder"
          exit 1
        }

        if [ -n "$normal_sample_name" ]; then
          {
            rm -f "$input_dir/$(basename "$normal_aligned_bam")"
            rm -f "$input_dir/$(basename "$normal_aligned_bam_index")"
            rm -f "$input_dir/$(basename "$normal_clair3_vcf")"
            rm -f "$input_dir/$(basename "$normal_clair3_vcf_index")"
          } || {
            echo "Error: Failed to remove input files from input folder"
            exit 1
          }
        fi


        echo "*************************"
        echo "HiPhase VCF phasing and BAM haplotagging completed successfully"
        echo "Output files copied to: $output_folder"
        echo "*************************"